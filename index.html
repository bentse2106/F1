<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Race Control Lap Timer - Dual Driver</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js for audio feedback -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <!-- Custom style for digital look and feel -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chivo+Mono:wght@400;700&display=swap');
        
        /* Apply the digital-style font */
        .digital-display {
            font-family: 'Chivo Mono', monospace;
            letter-spacing: -2px;
            transition: text-shadow 0.3s ease-in-out, color 0.3s ease-in-out;
        }

        /* Carbon Fiber-ish background pattern */
        .carbon-bg {
            background-color: #111;
            background-image: 
                linear-gradient(45deg, #1a1a1a 25%, transparent 25%, transparent 75%, #1a1a1a 75%, #1a1a1a),
                linear-gradient(45deg, #1a1a1a 25%, transparent 25%, transparent 75%, #1a1a1a 75%, #1a1a1a);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        /* Checkered Flag Pattern Animation */
        .checkered-strip {
            height: 24px;
            width: 100%;
            background-image: 
                linear-gradient(45deg, #000 25%, transparent 25%), 
                linear-gradient(-45deg, #000 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #000 75%), 
                linear-gradient(-45deg, transparent 75%, #000 75%);
            background-size: 20px 20px;
            background-color: #e5e7eb; /* gray-200 */
            border-bottom: 2px solid #ef4444;
        }

        /* Running state glow (Red for speed) */
        .running-glow {
            color: #ef4444; /* red-500 */
            text-shadow: 0 0 8px rgba(239, 68, 68, 0.8), 0 0 15px rgba(239, 68, 68, 0.5);
        }

        /* Stopped state glow (White/Silver for standby) */
        .stopped-glow {
            color: #d1d5db; /* gray-300 */
            text-shadow: 0 0 8px rgba(209, 213, 219, 0.7), 0 0 15px rgba(209, 213, 219, 0.4);
        }

        /* Customize scrollbar for lap list */
        .lap-list::-webkit-scrollbar {
            width: 6px;
        }
        .lap-list::-webkit-scrollbar-thumb {
            background-color: #ef4444; /* red-500 */
            border-radius: 3px;
        }
        .lap-list::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }

        /* Background Track SVG */
        .track-bg {
            background-image: url("data:image/svg+xml,%3Csvg width='200' height='200' viewBox='0 0 200 200' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M40 160C40 160 20 160 20 140C20 120 40 100 80 100C120 100 140 80 140 60C140 40 120 20 100 20C80 20 60 40 60 40' stroke='%23374151' stroke-width='4' stroke-opacity='0.3'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
        }

        /* F1 Lights Styling */
        .light {
            background-color: #1f2937; /* gray-800 off state */
            box-shadow: inset 0 0 10px #000;
        }
        .light-red {
            background-color: #ef4444; /* red-500 */
            box-shadow: 0 0 15px #ef4444, 0 0 30px #ef4444, inset 0 0 5px #fff;
            border-color: #fca5a5;
        }
        /* Green Light Style */
        .light-green {
            background-color: #22c55e; /* green-500 */
            box-shadow: 0 0 15px #22c55e, 0 0 30px #22c55e, inset 0 0 5px #fff;
            border-color: #86efac;
        }
    </style>
</head>
<body class="carbon-bg text-white min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Stopwatch Container -->
    <div class="w-full max-w-7xl bg-gray-800 rounded-2xl shadow-2xl overflow-hidden border-4 border-red-600 transition duration-300 hover:shadow-red-700/70 relative min-h-[600px] flex flex-col">
        
        <!-- Checkered Banner -->
        <div class="checkered-strip flex-shrink-0"></div>

        <div class="p-6 md:p-10 pt-8 flex-grow">
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 items-stretch h-full">
                
                <!-- LEFT PANEL: TIMER CONTROL -->
                <div class="flex flex-col justify-between h-full">
                    <!-- Header with F1 Icon -->
                    <div class="flex flex-col items-center mb-6">
                        <div class="flex items-center space-x-3 mb-2">
                            <!-- F1 Car SVG Icon -->
                            <svg class="w-24 h-12 text-red-500 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M1,12 L3,12 L4,14 L7,14 L8,12 L14,12 L15,10 L9,10 L8,8 L16,8 L19,10 L23,10 L23,12 L21,14 L23,14 L23,16 L1,16 Z M4,15 A1,1 0 1,0 4,17 A1,1 0 1,0 4,15 Z M19,15 A1,1 0 1,0 19,17 A1,1 0 1,0 19,15 Z" transform="scale(1, 0.8) translate(0, 3)"/>
                            </svg>
                        </div>
                        <h1 class="text-3xl font-bold text-center text-red-500 uppercase tracking-widest leading-none">
                            F1 RACE<br><span class="text-white text-xl tracking-[0.3em]">CONTROL</span>
                        </h1>
                    </div>

                    <!-- F1 START LIGHTS GANTRY -->
                    <div class="flex justify-center items-center gap-3 mb-10 p-4 bg-black rounded-lg border-2 border-gray-700 shadow-2xl">
                        <div class="light w-10 h-10 md:w-14 md:h-14 rounded-full border-4 border-gray-600 transition-all duration-75" id="light1"></div>
                        <div class="light w-10 h-10 md:w-14 md:h-14 rounded-full border-4 border-gray-600 transition-all duration-75" id="light2"></div>
                        <div class="light w-10 h-10 md:w-14 md:h-14 rounded-full border-4 border-gray-600 transition-all duration-75" id="light3"></div>
                        <div class="light w-10 h-10 md:w-14 md:h-14 rounded-full border-4 border-gray-600 transition-all duration-75" id="light4"></div>
                        <div class="light w-10 h-10 md:w-14 md:h-14 rounded-full border-4 border-gray-600 transition-all duration-75" id="light5"></div>
                    </div>

                    <!-- Main Display -->
                    <div class="relative mb-10">
                        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gray-800 px-2 text-xs text-gray-500 uppercase tracking-widest">
                            Session Time
                        </div>
                        <div id="display" class="digital-display text-7xl md:text-8xl lg:text-9xl text-center font-bold p-6 bg-gray-900 rounded-lg border-2 border-red-700 select-none stopped-glow">
                            00:00.000
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="space-y-4 mt-auto">
                        <!-- Main Start/Stop -->
                        <button id="mainButton" 
                                class="w-full px-4 py-5 text-xl font-bold rounded-xl transition duration-200 
                                    bg-green-600 hover:bg-green-700 text-white shadow-lg shadow-green-700/50 
                                    active:scale-95 disabled:opacity-50 disabled:grayscale flex items-center justify-center space-x-2 border-b-4 border-green-800"
                                onclick="handleMainButton()">
                            <span>START SEQUENCE</span>
                        </button>
                        
                        <!-- Driver Lap Buttons -->
                        <div class="flex space-x-4">
                            <!-- Driver 1 Button -->
                            <button id="lapButton1" 
                                    class="flex-1 px-4 py-5 text-lg font-bold rounded-xl transition duration-200 
                                        bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-700/50 
                                        active:scale-95 disabled:opacity-50 flex flex-col items-center justify-center border-b-4 border-blue-800 leading-none"
                                    onclick="lapResetStopwatch(1)" 
                                    disabled>
                                <span class="text-sm opacity-75 mb-1">DRIVER 1</span>
                                <span class="btn-text">LAP</span>
                            </button>

                            <!-- Driver 2 Button -->
                            <button id="lapButton2" 
                                    class="flex-1 px-4 py-5 text-lg font-bold rounded-xl transition duration-200 
                                        bg-orange-600 hover:bg-orange-700 text-white shadow-lg shadow-orange-700/50 
                                        active:scale-95 disabled:opacity-50 flex flex-col items-center justify-center border-b-4 border-orange-800 leading-none"
                                    onclick="lapResetStopwatch(2)" 
                                    disabled>
                                <span class="text-sm opacity-75 mb-1">DRIVER 2</span>
                                <span class="btn-text">LAP</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- RIGHT PANEL: LEADERBOARD & DATA (Visual Split) -->
                <div class="flex flex-col space-y-6 lg:border-l lg:border-gray-700 lg:pl-10 relative">
                    
                    <h2 class="text-xl font-semibold text-red-400 border-b border-red-700 pb-1 flex justify-between items-end">
                        <span>TEAM TELEMETRY</span>
                        <span class="text-xs text-gray-500 font-normal">REAL-TIME</span>
                    </h2>

                    <!-- Dual Driver Columns -->
                    <div class="grid grid-cols-2 gap-4 flex-1 min-h-[250px]">
                        
                        <!-- Driver 1 Column -->
                        <div class="flex flex-col bg-gray-900/30 rounded-lg p-2 border border-gray-700">
                            <!-- Input D1 -->
                            <div class="mb-2">
                                <input type="text" id="driverName1" value="HAM" maxlength="20" 
                                    class="bg-blue-900/20 text-blue-400 font-mono font-bold text-center w-full px-2 py-1 rounded border border-blue-900/50 focus:border-blue-500 focus:outline-none uppercase text-lg"
                                    placeholder="DRIVER 1">
                            </div>
                            <!-- List D1 -->
                            <div id="lapTimes1" class="lap-list flex-1 overflow-y-auto bg-gray-900 p-2 rounded border border-gray-800 relative z-10">
                                <p id="noLapsMessage1" class="text-gray-600 text-xs text-center py-10">Ready</p>
                            </div>
                        </div>

                        <!-- Driver 2 Column -->
                        <div class="flex flex-col bg-gray-900/30 rounded-lg p-2 border border-gray-700">
                            <!-- Input D2 -->
                            <div class="mb-2">
                                <input type="text" id="driverName2" value="RUS" maxlength="20" 
                                    class="bg-orange-900/20 text-orange-400 font-mono font-bold text-center w-full px-2 py-1 rounded border border-orange-900/50 focus:border-orange-500 focus:outline-none uppercase text-lg"
                                    placeholder="DRIVER 2">
                            </div>
                            <!-- List D2 -->
                            <div id="lapTimes2" class="lap-list flex-1 overflow-y-auto bg-gray-900 p-2 rounded border border-gray-800 relative z-10">
                                <p id="noLapsMessage2" class="text-gray-600 text-xs text-center py-10">Ready</p>
                            </div>
                        </div>
                    </div>

                    <!-- Leaderboard (Persistent) -->
                    <div class="relative flex-1 min-h-[250px] flex flex-col mt-4">
                        <h2 class="text-xl font-semibold mb-3 text-yellow-400 border-b border-yellow-700 pb-1 flex justify-between items-end">
                            <span>LEADERBOARD</span>
                            <span class="text-xs text-gray-500 font-normal">TOP 5 ALL-TIME</span>
                        </h2>
                        <div id="leaderboardList" class="bg-gray-900 p-3 rounded-lg border border-gray-700 flex-1">
                            <!-- Leaderboard items will be injected here -->
                            <p class="text-gray-500 text-xs text-center py-20">No records set yet.</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const display = document.getElementById('display');
        const mainButton = document.getElementById('mainButton');
        const lapButton1 = document.getElementById('lapButton1');
        const lapButton2 = document.getElementById('lapButton2');
        
        const lapTimesContainer1 = document.getElementById('lapTimes1');
        const lapTimesContainer2 = document.getElementById('lapTimes2');
        const noLapsMessage1 = document.getElementById('noLapsMessage1');
        const noLapsMessage2 = document.getElementById('noLapsMessage2');
        
        const driverInput1 = document.getElementById('driverName1');
        const driverInput2 = document.getElementById('driverName2');
        const leaderboardContainer = document.getElementById('leaderboardList');
        
        const lights = [
            document.getElementById('light1'),
            document.getElementById('light2'),
            document.getElementById('light3'),
            document.getElementById('light4'),
            document.getElementById('light5')
        ];

        // Audio setup (Tone.js)
        let synth = null;
        let audioInitialized = false;

        // Timer Variables
        let startTime = 0;
        let totalElapsedTimeMs = 0;
        let timerInterval = null;
        let isRunning = false;
        let isStartingSequence = false;
        let lightTimeouts = []; 
        
        // Driver Data State (Objects for easier management)
        const d1 = {
            id: 1,
            lapCounter: 0,
            previousTotalTimeMs: 0,
            lapHistory: [],
            fastestLap: Infinity,
            container: lapTimesContainer1,
            noLapsMsg: noLapsMessage1,
            input: driverInput1
        };

        const d2 = {
            id: 2,
            lapCounter: 0,
            previousTotalTimeMs: 0,
            lapHistory: [],
            fastestLap: Infinity,
            container: lapTimesContainer2,
            noLapsMsg: noLapsMessage2,
            input: driverInput2
        };

        // Leaderboard Variables
        const LEADERBOARD_KEY = 'f1_leaderboard_v2'; // Version bump for dual driver support
        let leaderboard = [];

        // --- Initialization ---
        
        // Load leaderboard on startup
        loadLeaderboard();
        renderLeaderboard();

        // Ensure driver names are uppercase
        [driverInput1, driverInput2].forEach(input => {
            input.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
            });
        });

        /**
         * Initializes audio.
         */
        function initAudio() {
            if (typeof Tone !== 'undefined' && !audioInitialized) {
                synth = new Tone.PolySynth(Tone.Synth).toDestination();
                synth.volume.value = -5;
                audioInitialized = true;
            }
        }

        /**
         * Beep for lights.
         */
        function playLightSound(type) {
            if (synth) {
                if (type === 'red') {
                    synth.triggerAttackRelease("G3", "0.1");
                } else if (type === 'go') {
                    synth.triggerAttackRelease(["C4", "E4", "G4"], "0.5");
                }
            }
        }

        /**
         * Play Lap Sound
         */
        function playLapSound(diff) {
            if (synth) {
                if (diff < 0) {
                    synth.triggerAttackRelease("G4", "0.1");
                } else {
                    synth.triggerAttackRelease("C4", "0.1");
                }
            }
        }

        function formatTime(time) {
            time = Math.max(0, time);
            const milliseconds = String(Math.floor((time % 1000))).padStart(3, '0');
            const totalSeconds = Math.floor(time / 1000);
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
            return `${minutes}:${seconds}.${milliseconds}`;
        }
        
        function formatTimeMs(time) {
            time = Math.abs(time);
            const totalSeconds = Math.floor(time / 1000);
            const milliseconds = String(Math.floor((time % 1000))).padStart(3, '0');
            return `${totalSeconds}.${milliseconds}`;
        }

        function updateDisplay() {
            if (isRunning) {
                totalElapsedTimeMs = Date.now() - startTime;
            }
            display.textContent = formatTime(totalElapsedTimeMs);
        }

        // --- Leaderboard Logic ---

        function loadLeaderboard() {
            const stored = localStorage.getItem(LEADERBOARD_KEY);
            if (stored) {
                try {
                    leaderboard = JSON.parse(stored);
                } catch (e) {
                    console.error("Failed to parse leaderboard", e);
                    leaderboard = [];
                }
            }
        }

        function saveToLeaderboard(timeMs, driverName) {
            const driver = driverName || "UNK";
            
            leaderboard.push({
                name: driver,
                time: timeMs,
                date: new Date().toISOString()
            });

            // Sort by time (ascending)
            leaderboard.sort((a, b) => a.time - b.time);

            // Keep top 5
            leaderboard = leaderboard.slice(0, 5);

            // Save to local storage
            localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(leaderboard));
            
            // Re-render
            renderLeaderboard();
        }

        function renderLeaderboard() {
            if (leaderboard.length === 0) {
                leaderboardContainer.innerHTML = '<p class="text-gray-500 text-xs text-center py-20">No records set yet.</p>';
                return;
            }

            let html = '<div class="space-y-1">';
            leaderboard.forEach((entry, index) => {
                const rank = index + 1;
                let rankColor = 'text-gray-400';
                if (rank === 1) rankColor = 'text-yellow-400';
                else if (rank === 2) rankColor = 'text-gray-300';
                else if (rank === 3) rankColor = 'text-orange-400';

                html += `
                    <div class="flex items-center justify-between text-sm py-2 border-b border-gray-800 last:border-0">
                        <div class="flex items-center space-x-3">
                            <span class="${rankColor} font-bold w-6 text-center text-lg digital-display">${rank}</span>
                            <span class="text-white font-mono font-bold bg-gray-800 px-2 py-0.5 rounded tracking-wide border border-gray-700 truncate max-w-[100px]">${entry.name}</span>
                        </div>
                        <span class="digital-display text-white text-lg">${formatTime(entry.time)}</span>
                    </div>
                `;
            });
            html += '</div>';
            leaderboardContainer.innerHTML = html;
        }

        // --- Control Logic ---

        function handleMainButton() {
            initAudio();

            if (isStartingSequence) {
                abortSequence();
                return;
            }

            if (isRunning) {
                stopStopwatch();
            } else {
                startLightSequence();
            }
        }

        function startLightSequence() {
            resetTimerStateOnly();
            isStartingSequence = true;
            
            lights.forEach(l => {
                l.classList.remove('light-red');
                l.classList.remove('light-green');
            });

            mainButton.querySelector('span').innerText = "ABORT START";
            mainButton.classList.replace('bg-green-600', 'bg-yellow-600');
            mainButton.classList.replace('border-green-800', 'border-yellow-800');
            mainButton.classList.replace('shadow-green-700/50', 'shadow-yellow-700/50');
            
            // Disable Lap Buttons
            lapButton1.disabled = true;
            lapButton2.disabled = true;

            for (let i = 0; i < 5; i++) {
                let t = setTimeout(() => {
                    lights[i].classList.add('light-red');
                    playLightSound('red');
                }, 1000 * (i + 1));
                lightTimeouts.push(t);
            }

            const totalWait = 6000; 

            let startT = setTimeout(() => {
                lightsOutAndGo();
            }, totalWait);
            lightTimeouts.push(startT);
        }

        function abortSequence() {
            isStartingSequence = false;
            lightTimeouts.forEach(t => clearTimeout(t));
            lightTimeouts = [];
            
            lights.forEach(l => {
                l.classList.remove('light-red');
                l.classList.remove('light-green');
            });

            mainButton.querySelector('span').innerText = "START SEQUENCE";
            mainButton.classList.replace('bg-yellow-600', 'bg-green-600');
            mainButton.classList.replace('border-yellow-800', 'border-green-800');
            mainButton.classList.replace('shadow-yellow-700/50', 'shadow-green-700/50');
        }

        function lightsOutAndGo() {
            isStartingSequence = false;
            
            lights.forEach(l => {
                l.classList.remove('light-red');
                l.classList.add('light-green');
            });
            
            playLightSound('go');

            isRunning = true;
            startTime = Date.now();
            
            const animate = () => {
                updateDisplay();
                if (isRunning) {
                    timerInterval = requestAnimationFrame(animate);
                }
            };
            timerInterval = requestAnimationFrame(animate);

            display.classList.remove('stopped-glow');
            display.classList.add('running-glow');

            mainButton.querySelector('span').innerText = "STOP SESSION";
            mainButton.classList.replace('bg-yellow-600', 'bg-red-600');
            mainButton.classList.replace('border-yellow-800', 'border-red-800');
            mainButton.classList.replace('shadow-yellow-700/50', 'shadow-red-700/50');
            
            // Enable Lap Buttons
            lapButton1.disabled = false;
            lapButton2.disabled = false;
            
            // Update Lap Button Text
            lapButton1.querySelector('.btn-text').innerText = "LAP";
            lapButton2.querySelector('.btn-text').innerText = "LAP";
            
            // Auto-clear green lights after 1 second
            setTimeout(() => {
                if (isRunning) {
                     lights.forEach(l => l.classList.remove('light-green'));
                }
            }, 1000);
        }

        function stopStopwatch() {
            isRunning = false;
            cancelAnimationFrame(timerInterval);
            timerInterval = null;
            
            lights.forEach(l => l.classList.remove('light-green'));

            display.classList.remove('running-glow');
            display.classList.add('stopped-glow');

            mainButton.querySelector('span').innerText = "START SEQUENCE";
            mainButton.classList.replace('bg-red-600', 'bg-green-600');
            mainButton.classList.replace('border-red-800', 'border-green-800');
            mainButton.classList.replace('shadow-red-700/50', 'shadow-green-700/50');
            
            // Change Lap buttons to Reset
            lapButton1.querySelector('.btn-text').innerText = "RESET";
            lapButton2.querySelector('.btn-text').innerText = "RESET";
            
            // Re-enable in case they were disabled
            lapButton1.disabled = false;
            lapButton2.disabled = false;
        }

        function lapResetStopwatch(driverId) {
            if (isRunning) {
                recordLap(driverId);
            } else {
                fullReset();
            }
        }
        
        function recordLap(driverId) {
            // Select correct driver state
            const driver = driverId === 1 ? d1 : d2;
            
            driver.lapCounter++;
            const totalTimeMs = totalElapsedTimeMs;
            const lapDurationMs = totalTimeMs - driver.previousTotalTimeMs;

            let diffFromPreviousMs = 0;
            if (driver.lapCounter > 1) {
                const previousLapDurationMs = driver.lapHistory[driver.lapHistory.length - 1].lapDurationMs;
                diffFromPreviousMs = lapDurationMs - previousLapDurationMs;
            }

            let isFastest = false;
            if (lapDurationMs < driver.fastestLap) {
                driver.fastestLap = lapDurationMs;
                isFastest = true;
            }

            // Check and Save to Leaderboard
            saveToLeaderboard(lapDurationMs, driver.input.value);

            driver.lapHistory.push({
                lap: driver.lapCounter,
                totalTimeMs: totalTimeMs,
                lapDurationMs: lapDurationMs,
                diffFromPreviousMs: diffFromPreviousMs
            });

            driver.previousTotalTimeMs = totalTimeMs;
            
            playLapSound(diffFromPreviousMs);
            renderDriverLapList(driver, isFastest);
        }

        function renderDriverLapList(driver, newLapIsFastest) {
            // Clear existing if it's the first real lap
            if (driver.lapCounter === 1) {
                driver.container.innerHTML = '';
            }

            // We append new laps to the TOP (prepend)
            const lap = driver.lapHistory[driver.lapHistory.length - 1];
            
            const lapElement = document.createElement('div');
            let lapClasses = 'flex justify-between items-center py-1 px-2 mb-1 rounded transition duration-150 backdrop-blur-sm text-xs ';
            
            if (newLapIsFastest) {
                // Gold highlight
                lapClasses += 'bg-yellow-900/60 border border-yellow-500/50 text-yellow-300 font-bold';
            } else {
                lapClasses += 'bg-gray-800/80 border border-gray-700 text-gray-300 hover:bg-gray-700/90';
            }

            const lapDurationDisplay = formatTime(lap.lapDurationMs);

            let diffHtml = '';
            if (lap.lap > 1) {
                const diff = lap.diffFromPreviousMs;
                let diffText, diffColor;

                if (diff < 0) {
                    diffText = `-${formatTimeMs(Math.abs(diff))}`;
                    diffColor = 'text-green-400'; 
                } else if (diff > 0) {
                    diffText = `+${formatTimeMs(diff)}`;
                    diffColor = 'text-red-400'; 
                } else {
                    diffText = 'Â±0.000';
                    diffColor = 'text-gray-400';
                }

                diffHtml = `<span class="${diffColor} digital-display ml-2 w-12 text-right">${diffText}</span>`;
            } else {
                 diffHtml = `<span class="w-12"></span>`;
            }

            lapElement.className = lapClasses;
            lapElement.innerHTML = `
                <span class="font-bold w-8">L${lap.lap}</span>
                <span class="digital-display flex-1 text-center text-sm">${lapDurationDisplay}</span>
                ${diffHtml}
            `;
            
            // Insert at the top
            if (driver.container.firstChild) {
                driver.container.insertBefore(lapElement, driver.container.firstChild);
            } else {
                driver.container.appendChild(lapElement);
            }
        }

        function resetTimerStateOnly() {
            totalElapsedTimeMs = 0;
            display.textContent = '00:00.000';

            // Reset Driver 1
            d1.lapCounter = 0;
            d1.previousTotalTimeMs = 0;
            d1.lapHistory = [];
            d1.fastestLap = Infinity;
            d1.container.innerHTML = '<p class="text-gray-600 text-xs text-center py-10">Ready</p>';

            // Reset Driver 2
            d2.lapCounter = 0;
            d2.previousTotalTimeMs = 0;
            d2.lapHistory = [];
            d2.fastestLap = Infinity;
            d2.container.innerHTML = '<p class="text-gray-600 text-xs text-center py-10">Ready</p>';
        }

        function fullReset() {
            if (timerInterval) {
                cancelAnimationFrame(timerInterval);
                timerInterval = null;
            }
            isRunning = false;
            resetTimerStateOnly();
            
            lights.forEach(l => {
                l.classList.remove('light-red');
                l.classList.remove('light-green');
            });
            
            // Disable Lap Buttons until Start
            lapButton1.disabled = true;
            lapButton2.disabled = true;

            // Restore "LAP" text just for clarity (though they are disabled)
            lapButton1.querySelector('.btn-text').innerText = "LAP";
            lapButton2.querySelector('.btn-text').innerText = "LAP";

            mainButton.querySelector('span').innerText = "START SEQUENCE"; 
            display.classList.remove('running-glow');
            display.classList.add('stopped-glow');
        }
    </script>

</body>
</html>
